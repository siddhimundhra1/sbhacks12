<!DOCTYPE html>
<html>
<head>
  <title>Passing Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Gochi+Hand&family=Indie+Flower&family=Nanum+Pen+Script&family=Shadows+Into+Light&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      overflow-x: hidden;
    }

    
    body {
      background-color: #f5e9d8;
      background-image: 
        radial-gradient(#e0d3b8 1px, transparent 1px),
        radial-gradient(#e0d3b8 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: 0 0, 20px 20px;
      min-height: 100vh;
      height: 100dvh; /* Use dynamic viewport height for mobile */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      font-family: 'Caveat', cursive;
      touch-action: manipulation;
    }
    
    .app-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      height: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .notes-container {
      flex: 1;
      background: #fffef0;
      border-radius: 12px;
      box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.1),
        inset 0 0 0 1px rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      border: 1px solid #d4c9b1;
    }
    
    /* Notebook paper lines */
    .notes-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 40px;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        #fffef0,
        #fffef0 24px,
        #e0e0e0 24px,
        #e0e0e0 25px
      );
      pointer-events: none;
      opacity: 0.3;
      z-index: 0;
    }
    
    .notes-header {
      background: linear-gradient(to bottom, #8b7355, #6d5c42);
      color: #fffef0;
      padding: 12px 15px;
      text-align: center;
      position: relative;
      z-index: 1;
      border-bottom: 2px solid #5a4a34;
      flex-shrink: 0;
    }
    
    .notes-header h2 {
      font-family: 'Shadows Into Light', cursive;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .notes-header .status {
      font-family: 'Indie Flower', cursive;
      font-size: 0.8rem;
      opacity: 0.9;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .notes-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: relative;
      z-index: 1;
      background: transparent;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    .note {
      max-width: 85%;
      padding: 12px 15px;
      line-height: 1.4;
      font-size: 1.1rem;
      position: relative;
      animation: slideIn 0.4s ease;
      word-wrap: break-word;
      word-break: break-word;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
      transform: rotate(-0.5deg);
      transition: transform 0.2s ease;
    }
    
    .note:active {
      transform: scale(0.98) rotate(0deg);
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateY(20px) rotate(-2deg); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) rotate(-0.5deg); 
      }
    }
    
    .user-note {
      background: #e3f2fd;
      align-self: flex-end;
      border-top-right-radius: 0;
      border: 1px solid #bbdefb;
      transform: rotate(0.5deg);
      font-family: 'Nanum Pen Script', cursive;
      font-size: 1.2rem;
      color: #1565c0;
      box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.1);
    }
    
    .ai-note {
      background: #fff8e1;
      align-self: flex-start;
      border-top-left-radius: 0;
      border: 1px solid #ffecb3;
      font-family: 'Gochi Hand', cursive;
      font-size: 1.15rem;
      color: #5d4037;
      box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.1);
    }
    
    .note-content {
      margin-bottom: 6px;
      line-height: 1.6;
    }
    
    .note-meta {
      font-family: 'Indie Flower', cursive;
      font-size: 0.8rem;
      opacity: 0.7;
      text-align: right;
      border-top: 1px dashed rgba(0, 0, 0, 0.1);
      padding-top: 4px;
      margin-top: 4px;
    }
    
    .note-meta::before {
      content: '~ ';
    }
    
    /* Pin effect for notes */
    .note::before {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, #fff, #ccc, #999);
      border-radius: 50%;
      top: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    .user-note::before {
      right: 8px;
      background: radial-gradient(circle, #bbdefb, #64b5f6, #1976d2);
    }
    
    .ai-note::before {
      left: 8px;
      background: radial-gradient(circle, #ffecb3, #ffd54f, #ff9800);
    }
    
    .transcript-indicator {
      text-align: center;
      font-family: 'Indie Flower', cursive;
      font-size: 0.9rem;
      color: #5d4037;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 6px;
      margin: 0 10px;
      display: none;
      border: 1px dashed #8d6e63;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 2;
      flex-shrink: 0;
    }
    
    .transcript-indicator.active {
      display: block;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .typing-indicator {
      display: none;
      align-self: flex-start;
      background: rgba(255, 248, 225, 0.9);
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #ffecb3;
      margin-bottom: 5px;
      font-family: 'Gochi Hand', cursive;
      font-size: 1rem;
      color: #5d4037;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }
    
    .typing-indicator.active {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .typing-dots {
      display: flex;
      gap: 4px;
    }
    
    .typing-dots span {
      width: 6px;
      height: 6px;
      background: #8d6e63;
      border-radius: 50%;
      animation: handwritingTyping 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes handwritingTyping {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }
    
    .input-area {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      padding: 12px 15px;
      background: rgba(255, 254, 240, 0.95);
      border-top: 2px solid #d4c9b1;
      display: flex;
      gap: 8px;
      align-items: center;
      position: relative;
      z-index: 1;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      flex-shrink: 0;
    }
    
    .note-input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #d4c9b1;
      border-radius: 8px;
      font-family: 'Nanum Pen Script', cursive;
      font-size: 1.1rem;
      outline: none;
      background: #fffef7;
      color: #5d4037;
      box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
      min-height: 44px; /* Minimum touch target size */
    }
    
    .note-input:focus {
      border-color: #8b7355;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.2);
    }
    
    .note-input::placeholder {
      color: #a1887f;
      font-style: italic;
    }
    
    .send-button {
      background: linear-gradient(to bottom, #8b7355, #6d5c42);
      color: #fffef0;
      border: none;
      min-width: 44px;
      min-height: 44px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
      font-family: 'Shadows Into Light', cursive;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      touch-action: manipulation;
    }
    
    .send-button:active {
      transform: scale(0.9);
      box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    .voice-controls {
      display: flex;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(255, 254, 240, 0.95);
      position: relative;
      z-index: 1;
      flex-shrink: 0;
      border-top: 1px solid #d4c9b1;
    }
    
    .voice-button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 25px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Indie Flower', cursive;
      font-weight: bold;
      letter-spacing: 0.3px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      min-height: 44px;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .voice-button:active {
      transform: translateY(1px);
      box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .record-button {
      background: linear-gradient(to bottom, #e57373, #d32f2f);
      color: white;
      border: 2px solid #c62828;
    }
    
    .record-button.recording {
      animation: pulse 1.5s infinite;
      background: linear-gradient(to bottom, #f44336, #b71c1c);
      box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    .stop-button {
      background: linear-gradient(to bottom, #78909c, #455a64);
      color: white;
      border: 2px solid #37474f;
    }
    
    .stop-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Quiz styling */
    .quiz-note {
      background: #f3e5f5;
      border: 1px solid #ce93d8;
      font-family: 'Gochi Hand', cursive;
    }
    
    .quiz-note::before {
      background: radial-gradient(circle, #f3e5f5, #ce93d8, #8e24aa);
    }
    
    .quiz-question {
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }
    
    .quiz-option {
      padding: 8px 10px;
      border: 1px solid #ba68c8;
      border-radius: 6px;
      background: #f3e5f5;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Nanum Pen Script', cursive;
      font-size: 1rem;
      min-height: 40px;
      display: flex;
      align-items: center;
      touch-action: manipulation;
    }
    
    .quiz-option:active {
      background: #e1bee7;
      transform: translateX(3px);
    }
    
    .quiz-option.correct {
      background: #c8e6c9;
      border-color: #4caf50;
      color: #1b5e20;
    }
    
    .quiz-option.incorrect {
      background: #ffcdd2;
      border-color: #f44336;
      color: #b71c1c;
    }

    .note-input {
        min-width: 0;
      }

    
    /* Scrollbar styling */
    .notes-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .notes-content::-webkit-scrollbar-track {
      background: rgba(212, 201, 177, 0.3);
      border-radius: 3px;
    }
    
    .notes-content::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #8b7355, #6d5c42);
      border-radius: 3px;
    }
    
    .notes-content::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, #6d5c42, #5a4a34);
    }
    
    /* Tear effect at top of notes */
    .notes-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 10px;
      background: linear-gradient(to right, 
        transparent 0%, 
        rgba(212, 201, 177, 0.5) 10%, 
        rgba(212, 201, 177, 0.5) 90%, 
        transparent 100%);
      z-index: 1;
    }
    
    .export-button {
      width: 100%;
      background: linear-gradient(to bottom, #4caf50, #2e7d32);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-family: 'Indie Flower', cursive;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s;
      min-height: 50px;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .export-button:active {
      transform: translateY(1px);
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.2);
      background: linear-gradient(to bottom, #43a047, #1b5e20);
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
      body {
        padding: 8px;
        height: 100dvh;
      }
      
      .app-container {
        max-height: 95vh;
        gap: 8px;
      }
      
      .notes-container {
        border-radius: 10px;
      }
      
      .notes-header {
        padding: 10px 12px;
      }
      
      .notes-header h2 {
        font-size: 1.3rem;
      }
      
      .notes-header .status {
        font-size: 0.75rem;
      }
      
      .notes-content {
        padding: 12px;
        gap: 12px;
      }
      
      .note {
        max-width: 90%;
        padding: 10px 12px;
        font-size: 1rem;
      }
      
      .user-note {
        font-size: 1.1rem;
      }
      
      .ai-note {
        font-size: 1.05rem;
      }
      
      .note-content {
        line-height: 1.5;
      }
      
      .input-area {
        padding: 10px 12px;
      }
      
      .note-input {
        font-size: 1rem;
        padding: 8px 10px;
      }
      
      .voice-controls {
        padding: 8px 12px;
        flex-direction: column;
      }
      
      .voice-button {
        font-size: 0.85rem;
        padding: 10px;
      }
      
      .quiz-option {
        padding: 8px;
        font-size: 0.95rem;
      }
      
      .export-button {
        padding: 12px 16px;
        font-size: 0.95rem;
        border-radius: 20px;
      }
    }
    
    @media (max-width: 480px) {
      .notes-container::before {
        left: 30px;
      }
      
      .note {
        max-width: 95%;
      }
      
      .notes-header h2 {
        font-size: 1.2rem;
      }
      
      .note-input::placeholder {
        font-size: 0.9rem;
      }
      
      .voice-button span {
        display: none; /* Hide text on very small screens, show only icons */
      }
      
      .voice-button::before {
        content: attr(data-label);
        font-size: 0.8rem;
      }
      
      .record-button::before {
        content: "üé§";
      }
      
      .stop-button::before {
        content: "‚èπÔ∏è";
      }
    }
    
    /* Landscape mode optimization */
    @media (max-height: 500px) and (orientation: landscape) {
      .app-container {
        max-height: 85vh;
      }
      
      .notes-header {
        padding: 8px 10px;
      }
      
      .notes-content {
        padding: 8px;
        gap: 8px;
      }
      
      .note {
        padding: 8px 10px;
        font-size: 0.9rem;
      }
      
      .input-area, .voice-controls {
        padding: 8px 10px;
      }
      
      .export-button {
        padding: 10px;
        min-height: 44px;
      }
    }
    
    /* Prevent text selection on interactive elements */
    button, .quiz-option {
      user-select: none;
      -webkit-user-select: none;
    }
    

    
    /* Hide scrollbar for cleaner mobile look */
    @media (max-width: 768px) {
      .notes-content::-webkit-scrollbar {
        display: none;
      }
      
      .notes-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }
  </style>


</head>
<body>
  <div class="app-container">
    <div class="notes-container">
      <div class="notes-header">
        <h2>üìù Passing Notes</h2>
        <div class="status">Whispering with AI ‚Ä¢ Class is in session</div>
      </div>
      
      <div class="transcript-indicator" id="transcriptIndicator">
        ‚úèÔ∏è Recording lecture notes...
      </div>
      
      <div class="notes-content" id="notesContent">
        <div class="note ai-note">
          <div class="note-content">
            Hi there! I'm here to help you take notes. You can type questions or record your lecture, and I'll help summarize and quiz you on it. What would you like to chat about?
          </div>
          <div class="note-meta">Ace ‚Ä¢ Just now</div>
        </div>
      </div>
      
      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div style="margin-left: 10px;">Thinking...</div>
      </div>
      
      <div class="input-area">
        <input type="text" class="note-input" id="noteInput" placeholder="Write your note here..." autocomplete="off">
        <button class="send-button" id="sendBtn">‚úèÔ∏è</button>
      </div>
      
      <div class="voice-controls">
        <button class="voice-button record-button" id="startVoiceBtn">üé§ Start Recording Lecture</button>
        <button class="voice-button stop-button" id="stopVoiceBtn" disabled>‚èπÔ∏è Stop & Process</button>
      </div>
    </div>
    
    <button id="exportPdfBtn" class="export-button">‚¨áÔ∏è Export Notes as PDF</button>
  </div>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    const notesContent = document.getElementById("notesContent");
    const noteInput = document.getElementById("noteInput");
    const sendBtn = document.getElementById("sendBtn");
    const startVoiceBtn = document.getElementById("startVoiceBtn");
    const stopVoiceBtn = document.getElementById("stopVoiceBtn");
    const transcriptIndicator = document.getElementById("transcriptIndicator");
    const typingIndicator = document.getElementById("typingIndicator");

    // -------------------- Utility Functions --------------------
    function formatTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const dateStr = now.toLocaleDateString([], { month: 'short', day: 'numeric' });
      return `${timeStr} ‚Ä¢ ${dateStr}`;
    }

    function addNote(text, isUser = false, metadata = null) {
      const noteDiv = document.createElement("div");
      noteDiv.className = `note ${isUser ? 'user-note' : 'ai-note'}`;
      
      const contentDiv = document.createElement("div");
      contentDiv.className = "note-content";
      contentDiv.textContent = text;
      
      const metaDiv = document.createElement("div");
      metaDiv.className = "note-meta";
      
      if (metadata) {
        metaDiv.textContent = metadata;
      } else {
        metaDiv.textContent = isUser ? "You ‚Ä¢ " + formatTime() : "Ace ‚Ä¢ " + formatTime();
      }
      
      noteDiv.appendChild(contentDiv);
      noteDiv.appendChild(metaDiv);
      
      notesContent.appendChild(noteDiv);
      notesContent.scrollTop = notesContent.scrollHeight;
    }

    function showTypingIndicator(show) {
      typingIndicator.classList.toggle("active", show);
      if (show) {
        notesContent.scrollTop = notesContent.scrollHeight;
      }
    }

    // -------------------- Speech Recognition --------------------
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-US";
    recognition.continuous = true;
    recognition.interimResults = true;

    let transcriptBuffer = "";
    let fullLectureTranscript = ""; 
    let isRecording = false;

    recognition.onresult = (event) => {
      let newText = "";
      
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          newText += transcript + " ";
        }
      }

      if (newText) {
        transcriptBuffer += newText;
        fullLectureTranscript += newText;

        if (!transcriptIndicator.classList.contains("active")) {
          transcriptIndicator.classList.add("active");
        }
        // Update indicator with transcript preview
        const preview = transcriptBuffer.length > 100 
          ? transcriptBuffer.substring(0, 100) + "..."
          : transcriptBuffer;
        transcriptIndicator.textContent = `‚úèÔ∏è Recording: ${preview}`;
      }
    };

    recognition.onstart = () => {
      console.log("Recording started");
      isRecording = true;
      startVoiceBtn.classList.add("recording");
      startVoiceBtn.textContent = "üî¥ Recording Lecture...";
      transcriptIndicator.textContent = "üé§ Listening to lecture...";
      transcriptIndicator.classList.add("active");
    };

    recognition.onend = () => {
      console.log("Recording ended");
      startVoiceBtn.classList.remove("recording");
      startVoiceBtn.textContent = "üé§ Start Recording Lecture";
      
      if (isRecording) {
        setTimeout(() => {
          try {
            recognition.start();
          } catch (e) {
            console.warn("Restart failed:", e);
          }
        }, 200);
      } else {
        startVoiceBtn.disabled = false;
        stopVoiceBtn.disabled = true;
        transcriptIndicator.classList.remove("active");
      }
    };

    recognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
      transcriptIndicator.textContent = `Error: ${event.error}`;
      setTimeout(() => {
        transcriptIndicator.classList.remove("active");
      }, 3000);
      isRecording = false;
      startVoiceBtn.disabled = false;
      stopVoiceBtn.disabled = true;
    };

    startVoiceBtn.addEventListener("click", () => {
      if (isRecording) return;
      
      try {
        isRecording = true;
        transcriptBuffer = "";
        recognition.start();
        startVoiceBtn.disabled = true;
        stopVoiceBtn.disabled = false;
      } catch (e) {
        console.error("Failed to start recording:", e);
        isRecording = false;
        startVoiceBtn.disabled = false;
        alert("Please allow microphone access to record lectures.");
      }
    });

    stopVoiceBtn.addEventListener("click", () => {
      if (!isRecording) return;
      
      isRecording = false;
      recognition.stop();
      startVoiceBtn.disabled = false;
      stopVoiceBtn.disabled = true;
      
      // Process the transcript
      setTimeout(async () => {
        if (transcriptBuffer.trim()) {
        await sendSummary(transcriptBuffer);
        transcriptBuffer = "";
      }

      await generateQuiz(fullLectureTranscript);

        transcriptIndicator.classList.remove("active");
      }, 500);
    });

    // -------------------- Summary sender --------------------
    async function sendSummary(chunk) {
      if (!transcriptBuffer.trim()) {
        transcriptIndicator.classList.remove("active");
        return;
      }

      addNote(transcriptBuffer, true, "Lecture notes ‚Ä¢ " + formatTime());
      showTypingIndicator(true);
      transcriptIndicator.classList.remove("active");

      try {
        const res = await fetch("/summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            full_text: fullLectureTranscript,
            new_chunk: chunk
          })

        });

        showTypingIndicator(false);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        addNote(data.reply, false, "Summary ‚Ä¢ " + formatTime());

      } catch (err) {
        showTypingIndicator(false);
        addNote(`Oops, I ran into an issue: ${err.message}`, false, "Error ‚Ä¢ " + formatTime());
        console.error("Summary error:", err);
      }
    }

    // -------------------- Quiz Creator --------------------
    async function generateQuiz(transcript) {
      if (!transcript.trim()) return;

      showTypingIndicator(true);

      try {
        const res = await fetch("/quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: transcript })
        });

        showTypingIndicator(false);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data.error) {
          addNote("Quiz didn't work out: " + data.error, false, "Oops ‚Ä¢ " + formatTime());
          console.error(data);
          return;
        }

        addNote("üìö Pop quiz from today's notes!", false, "Quiz Time! ‚Ä¢ " + formatTime());

        // Render quiz
        const quizData = data.quiz || [];
        quizData.forEach((q, idx) => {
          const quizNote = document.createElement("div");
          quizNote.className = "note quiz-note";
          
          const questionDiv = document.createElement("div");
          questionDiv.className = "quiz-question";
          questionDiv.textContent = `Q${idx + 1}: ${q.question}`;
          questionDiv.style.fontSize = "1.3rem";
          questionDiv.style.marginBottom = "15px";
          
          const optionsDiv = document.createElement("div");
          optionsDiv.className = "quiz-options";
          
          const options = q.options || ["A", "B", "C", "D"];
          const answer = q.answer || "A";
          
          options.forEach(option => {
            const optionBtn = document.createElement("button");
            optionBtn.className = "quiz-option";
            optionBtn.textContent = option;
            
            optionBtn.addEventListener("click", () => {
              // Disable all options
              optionsDiv.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = "default";
              });
              
              if (option === answer) {
                optionBtn.classList.add("correct");
                optionBtn.innerHTML = `‚úì ${option} (Correct!)`;
              } else {
                optionBtn.classList.add("incorrect");
                optionBtn.innerHTML = `‚úó ${option}`;
                
                // Highlight correct answer
                optionsDiv.querySelectorAll('.quiz-option').forEach(btn => {
                  if (btn.textContent.includes(answer) || btn.textContent === answer) {
                    btn.classList.add("correct");
                    btn.innerHTML = `‚úì ${answer} (Correct answer)`;
                  }
                });
              }
            });
            
            optionsDiv.appendChild(optionBtn);
          });
          
          quizNote.appendChild(questionDiv);
          quizNote.appendChild(optionsDiv);
          
          const metaDiv = document.createElement("div");
          metaDiv.className = "note-meta";
          metaDiv.textContent = `Question ${idx + 1} of ${quizData.length}`;
          quizNote.appendChild(metaDiv);
          
          notesContent.appendChild(quizNote);
          notesContent.scrollTop = notesContent.scrollHeight;
        });

      } catch (err) {
        showTypingIndicator(false);
        addNote(`Quiz didn't load: ${err.message}`, false, "Error ‚Ä¢ " + formatTime());
        console.error("Quiz error:", err);
      }
    }

    // -------------------- Auto-summary every 30 seconds --------------------
    setInterval(() => {
  if (transcriptBuffer.trim() && isRecording) {
    (async () => {
      await sendSummary(transcriptBuffer);
      transcriptBuffer = "";
    })();
  }
}, 15000);


    // -------------------- Manual notes --------------------
    async function sendNote() {
      const noteText = noteInput.value.trim();
      if (!noteText) return;

      addNote(noteText, true);
      noteInput.value = "";
      showTypingIndicator(true);

      try {
        const res = await fetch("/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: noteText,
          full_text: fullLectureTranscript
        })
      });


        showTypingIndicator(false);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        addNote(data.reply, false);

      } catch (err) {
        showTypingIndicator(false);
        addNote(`Hmm, something went wrong: ${err.message}`, false, "Error ‚Ä¢ " + formatTime());
        console.error("Note error:", err);
      }
    }

    sendBtn.addEventListener("click", sendNote);
    noteInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendNote();
      }
    });

    // Focus input on load
    noteInput.focus();
    
    // Add some random rotation to existing notes for realistic look
    document.querySelectorAll('.note').forEach(note => {
      const randomRotate = (Math.random() * 2) - 1; // -1 to 1 degrees
      note.style.transform = `rotate(${randomRotate}deg)`;
    });















// Replace the entire PDF export section with this:

document.getElementById("exportPdfBtn").addEventListener("click", () => {
  // Clone the notes content to avoid modifying the original
  const content = document.getElementById("notesContent").cloneNode(true);
  
  // Remove interactive elements
  content.querySelectorAll('button, input, .typing-indicator, .transcript-indicator').forEach(el => el.remove());
  
  // Create a clean container for PDF content
  const pdfContainer = document.createElement('div');
  pdfContainer.style.cssText = 'padding: 20px; background: white; color: #000000; font-family: Arial, sans-serif;';
  
  // Add title
  const title = document.createElement('div');
  title.style.cssText = 'text-align:center; margin-bottom:30px;';
  title.innerHTML = `
    <h1 style="color:#000000; font-size:24px; margin-bottom:10px;">üìù Lecture Notes</h1>
    <div style="color:#333333; font-size:14px;">
      Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
    </div>
    <hr style="margin:20px 0; border:1px solid #cccccc;" />
  `;
  pdfContainer.appendChild(title);
  
  // Process each note and create clean PDF versions
  content.querySelectorAll('.note').forEach(note => {
    const noteContent = note.querySelector('.note-content')?.textContent;
    const noteMeta = note.querySelector('.note-meta')?.textContent;
    const isUser = note.classList.contains('user-note');
    const isAI = note.classList.contains('ai-note');
    const isQuiz = note.classList.contains('quiz-note');
    
    if (!noteContent) return;
    
    const pdfNote = document.createElement('div');
    pdfNote.style.cssText = `
      margin-bottom: 20px;
      padding: 15px;
      border-left: 4px solid ${isUser ? '#1976d2' : (isQuiz ? '#8e24aa' : '#ff9800')};
      background: ${isUser ? '#f0f7ff' : (isQuiz ? '#f5f0ff' : '#fff8e1')};
      border-radius: 4px;
      color: #000000;
      font-size: 14px;
      line-height: 1.5;
      page-break-inside: avoid;
    `;
    
    // Add note type indicator
    const typeIndicator = document.createElement('div');
    typeIndicator.style.cssText = 'font-size: 12px; color: #555555; margin-bottom: 8px; font-weight: bold;';
    
    if (isUser) {
      typeIndicator.innerHTML = 'üì§ <strong>Your Note</strong>';
    } else if (isQuiz) {
      typeIndicator.innerHTML = 'üìö <strong>Quiz Question</strong>';
    } else {
      typeIndicator.innerHTML = 'ü§ñ <strong>AI Response</strong>';
    }
    pdfNote.appendChild(typeIndicator);
    
    // Add note content with forced dark text
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = 'color: #000000 !important; font-size: 14px !important; margin-bottom: 10px;';
    contentDiv.textContent = noteContent;
    pdfNote.appendChild(contentDiv);
    
    // Add metadata with dark text
    if (noteMeta) {
      const metaDiv = document.createElement('div');
      metaDiv.style.cssText = 'font-size: 11px !important; color: #666666 !important; text-align: right; border-top: 1px solid #eeeeee; padding-top: 8px; margin-top: 8px;';
      metaDiv.textContent = noteMeta;
      pdfNote.appendChild(metaDiv);
    }
    
    // Handle quiz options if present
    if (isQuiz) {
      const quizOptions = note.querySelectorAll('.quiz-option');
      if (quizOptions.length > 0) {
        const optionsDiv = document.createElement('div');
        optionsDiv.style.cssText = 'margin-top: 10px; padding-left: 15px;';
        
        quizOptions.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.style.cssText = 'color: #000000 !important; margin: 5px 0; padding: 5px 10px; border: 1px solid #cccccc; border-radius: 3px; background: #f9f9f9;';
          optionDiv.textContent = option.textContent;
          optionsDiv.appendChild(optionDiv);
        });
        
        pdfNote.appendChild(optionsDiv);
      }
    }
    
    pdfContainer.appendChild(pdfNote);
  });
  
  // Add footer
  const footer = document.createElement('div');
  footer.style.cssText = 'margin-top: 40px; padding-top: 20px; border-top: 1px solid #cccccc; text-align: center; font-size: 12px; color: #666666;';
  footer.innerHTML = `
    <div>Generated by Passing Notes App</div>
    <div>Total Notes: ${content.querySelectorAll('.note').length}</div>
  `;
  pdfContainer.appendChild(footer);
  
  // Configure html2pdf with settings optimized for text visibility
  const options = {
    margin: [0.5, 0.5, 0.5, 0.5],
    filename: `lecture-notes-${new Date().toISOString().slice(0,10)}.pdf`,
    image: { 
      type: 'jpeg', 
      quality: 0.98 
    },
    html2canvas: { 
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false,
      onclone: function(clonedDoc) {
        // Ensure everything is visible in the cloned document
        clonedDoc.body.style.color = '#000000';
        clonedDoc.body.style.backgroundColor = '#ffffff';
        clonedDoc.querySelectorAll('*').forEach(el => {
          el.style.color = '#000000';
        });
      }
    },
    jsPDF: { 
      unit: 'in', 
      format: 'letter', 
      orientation: 'portrait' 
    }
  };
  
  // Generate PDF from our clean container
  html2pdf().set(options).from(pdfContainer).save();
});

  </script>
  

</body>
</html>
